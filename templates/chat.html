<script>
  const chatBox = document.getElementById('chat-box');
  const chatForm = document.getElementById('chat-form');
  const userInput = document.getElementById('user-input');
  const clearBtn = document.getElementById('clear-chat-btn');

  function setTyping(isTyping) {
    let typingElem = document.getElementById('typing-indicator');
    if (!typingElem && isTyping) {
      typingElem = document.createElement('div');
      typingElem.id = 'typing-indicator';
      typingElem.textContent = 'ðŸ¤– escribiendo...';
      chatBox.appendChild(typingElem);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    if (typingElem) {
      typingElem.style.display = isTyping ? 'block' : 'none';
      if (!isTyping) typingElem.remove();
    }
  }

  function appendMessage(sender, message) {
    const msgDiv = document.createElement('div');
    msgDiv.className = sender === 'user' ? 'user-msg' : 'bot-msg';
    msgDiv.textContent = message;
    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = userInput.value.trim();
    if (!message) return;
    appendMessage('user', message);
    userInput.value = '';
    setTyping(true);
    try {
      const response = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });
      const data = await response.json();
      appendMessage('bot', data.response);
    } catch {
      appendMessage('bot', 'Error: no se pudo conectar al servidor.');
    }
    setTyping(false);
  });

  clearBtn.addEventListener('click', () => {
    chatBox.innerHTML = `<div class="bot-msg">Hola ðŸ‘‹ Soy el Chatbot Ambiental Persol. Puedes preguntarme sobre normativas, capacitaciones o gestiÃ³n ambiental.</div>`;
  });

  async function loadHistory() {
    try {
      const res = await fetch('/history');
      const history = await res.json();
      history.forEach(pair => {
        appendMessage('user', pair.user);
        appendMessage('bot', pair.bot);
      });
    } catch (err) {
      console.error('Error al cargar historial', err);
    }
  }

  window.onload = loadHistory;
</script>
